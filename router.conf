# ðŸ”¥ 5651 Real-Time Log Router (Auto Interface Detection + Real-Time Permissions)
# Otomatik interface algÄ±lama sistemi + Real-time izin ayarlarÄ±

# ModÃ¼l yÃ¼kleme
module(load="imudp")
module(load="imtcp")

# UDP ve TCP dinleme portlarÄ±
input(type="imudp" port="514")
input(type="imtcp" port="514")

# Template'ler
template(name="DeviceInterfacePath" type="string" 
         string="/var/log/5651/devices/%fromhost-ip%/interfaces/%$.target_interface%/%$YEAR%/%$MONTH%/%$DAY%/mikrotik-%fromhost-ip%-%$.target_interface%-%$YEAR%%$MONTH%%$DAY%.log")

# Mikrotik loglarÄ± iÃ§in otomatik interface yÃ¶nlendirme + REAL-TIME Ä°ZÄ°N AYARLARI
if ($fromhost-ip != "") then {
    # Interface name'i belirle
    set $.target_interface = "general";
    
    # Ã–nce out deÄŸerini kontrol et
    if ($msg contains "out:") then {
        set $.out_interface = re_extract($msg, "out:([^[:space:],]+)", 0, 1, "");
    } else {
        set $.out_interface = "";
    }
    
    # Sonra in deÄŸerini kontrol et
    if ($msg contains "in:") then {
        set $.in_interface = re_extract($msg, "in:([^[:space:]]+)", 0, 1, "");
    } else {
        set $.in_interface = "";
    }
    
    # Otomatik interface seÃ§imi:
    # 1. EÄŸer out deÄŸeri Ã¶nemli bir interface ise (HOTEL/AVM/OKUL/YURT/KONUKEVI/RESTAURANT/CAFE/2205) onu kullan
    # 2. EÄŸer in deÄŸeri Ã¶nemli bir interface ise onu kullan
    # 3. Yoksa out deÄŸerini kullan
    # 4. Son Ã§are in deÄŸerini kullan
    
    # Ã–nemli interface'leri kontrol et (out)
    if ($.out_interface != "" and 
        ($.out_interface contains "HOTEL" or 
         $.out_interface contains "AVM" or 
         $.out_interface contains "OKUL" or 
         $.out_interface contains "YURT" or 
         $.out_interface contains "KONUKEVI" or 
         $.out_interface contains "RESTAURANT" or
         $.out_interface contains "CAFE" or
         $.out_interface contains "2205")) then {
        set $.target_interface = $.out_interface;
    # Ã–nemli interface'leri kontrol et (in)
    } else if ($.in_interface != "" and 
               ($.in_interface contains "HOTEL" or 
                $.in_interface contains "AVM" or 
                $.in_interface contains "OKUL" or 
                $.in_interface contains "YURT" or 
                $.in_interface contains "KONUKEVI" or 
                $.in_interface contains "RESTAURANT" or
                $.in_interface contains "CAFE" or
                $.in_interface contains "2205")) then {
        set $.target_interface = $.in_interface;
    } else if ($.out_interface != "") then {
        set $.target_interface = $.out_interface;
    } else if ($.in_interface != "") then {
        set $.target_interface = $.in_interface;
    }
    
    # Interface name boÅŸsa genel olarak ayarla
    if ($.target_interface == "") then {
        set $.target_interface = "general";
    }
    
    # REAL-TIME Ä°ZÄ°N AYARLARI Ä°LE DÄ°NAMÄ°K DOSYA YAZMA
    # createDirs="on" - KlasÃ¶rleri otomatik oluÅŸturur
    # fileCreateMode="0640" - Dosya izinleri (rw-r-----)
    # dirCreateMode="0755" - KlasÃ¶r izinleri (rwxr-xr-x)
    # fileOwner="syslog" - Dosya sahibi
    # fileGroup="adm" - Dosya grubu
    action(type="omfile" dynaFile="DeviceInterfacePath" 
           template="RSYSLOG_TraditionalFileFormat"
           createDirs="on"
           fileCreateMode="0640"
           dirCreateMode="0755"
           fileOwner="syslog"
           fileGroup="adm")
    stop
}

# Genel log (sadece bilinmeyen cihazlar iÃ§in)
*.* /var/log/5651/general.log 